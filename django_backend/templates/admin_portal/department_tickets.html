{% extends 'admin_portal/base.html' %}

{% block title %}{{ department }} - Tickets{% endblock %}

{% block page_title %}{{ department }}{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'admin_portal:dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item active">{{ department }}</li>
    </ol>
</nav>
{% endblock %}

{% block extra_css %}
<style>
    /* Kanban Board Styles */
    .filters-container {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .filter-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .kanban-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1.5rem;
        margin-top: 1.5rem;
    }
    
    .kanban-column {
        background: white;
        border-radius: 12px;
        padding: 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        min-height: 500px;
    }
    
    .kanban-column-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1rem;
        margin-bottom: 1rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.875rem;
    }
    
    .kanban-column-header.submitted {
        background-color: rgba(245, 158, 11, 0.1);
        color: #F59E0B;
    }
    
    .kanban-column-header.assigned {
        background-color: rgba(59, 130, 246, 0.1);
        color: #3B82F6;
    }
    
    .kanban-column-header.in-progress {
        background-color: rgba(129, 140, 248, 0.1);
        color: #818CF8;
    }
    
    .kanban-column-header.resolved {
        background-color: rgba(16, 185, 129, 0.1);
        color: #10B981;
    }
    
    .kanban-tickets {
        min-height: 400px;
    }
    
    .ticket-card {
        background: white;
        border: 1px solid #E5E7EB;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        cursor: move;
        transition: all 0.2s ease;
        position: relative;
    }
    
    .ticket-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }
    
    .ticket-card.dragging {
        opacity: 0.5;
    }
    
    .ticket-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.75rem;
    }
    
    .ticket-number {
        font-weight: 600;
        color: #4F46E5;
        font-size: 0.875rem;
    }
    
    .ticket-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    
    .ticket-image {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 6px;
        margin-bottom: 0.75rem;
    }
    
    .ticket-category {
        font-weight: 600;
        color: #1F2937;
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
    }
    
    .ticket-location {
        font-size: 0.75rem;
        color: #6B7280;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    .ticket-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.75rem;
    }
    
    .ticket-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-weight: 500;
    }
    
    .badge-severity {
        background-color: #FEF3C7;
        color: #92400E;
    }
    
    .badge-contractor {
        background-color: #DBEAFE;
        color: #1E40AF;
    }
    
    .badge-ward {
        background-color: #D1FAE5;
        color: #065F46;
    }
    
    /* Bulk Actions Toolbar */
    .bulk-actions-toolbar {
        position: fixed;
        bottom: 2rem;
        left: 50%;
        transform: translateX(-50%);
        background: #1F2937;
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        display: none;
        align-items: center;
        gap: 1rem;
        z-index: 1000;
    }
    
    .bulk-actions-toolbar.active {
        display: flex;
    }
    
    /* Modal Styles */
    .modal-lg {
        max-width: 900px;
    }
    
    .modal-image {
        width: 100%;
        max-height: 400px;
        object-fit: contain;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    
    .info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .info-item {
        padding: 0.75rem;
        background-color: #F9FAFB;
        border-radius: 6px;
    }
    
    .info-label {
        font-size: 0.75rem;
        color: #6B7280;
        font-weight: 600;
        text-transform: uppercase;
        margin-bottom: 0.25rem;
    }
    
    .info-value {
        font-size: 0.875rem;
        color: #1F2937;
        font-weight: 500;
    }
    
    .notes-section {
        max-height: 300px;
        overflow-y: auto;
        margin-bottom: 1rem;
    }
    
    .note-item {
        padding: 0.75rem;
        background-color: #F9FAFB;
        border-radius: 6px;
        margin-bottom: 0.75rem;
        border-left: 3px solid #4F46E5;
    }
    
    .note-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }
    
    .note-author {
        font-weight: 600;
        font-size: 0.875rem;
        color: #1F2937;
    }
    
    .note-time {
        font-size: 0.75rem;
        color: #6B7280;
    }
    
    .note-content {
        font-size: 0.875rem;
        color: #4B5563;
    }
    
    /* Responsive */
    @media (max-width: 1200px) {
        .kanban-container {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    @media (max-width: 768px) {
        .kanban-container {
            grid-template-columns: 1fr;
        }
        
        .filter-row {
            grid-template-columns: 1fr;
        }
        
        .info-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Filters Section -->
<div class="filters-container">
    <form method="GET" id="filterForm">
        <div class="filter-row">
            <div>
                <label class="form-label">Search</label>
                <input type="text" name="search" class="form-control" placeholder="Ticket #, Category, Location..." value="{{ filters.search|default:'' }}">
            </div>
            <div>
                <label class="form-label">Contractor</label>
                <select name="contractor" class="form-select">
                    <option value="">All Contractors</option>
                    {% for contractor in contractors %}
                    <option value="{{ contractor.id }}" {% if filters.contractor == contractor.id|stringformat:"s" %}selected{% endif %}>
                        {{ contractor.contractor_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="form-label">Ward</label>
                <select name="ward" class="form-select">
                    <option value="">All Wards</option>
                    {% for ward in wards %}
                    <option value="{{ ward.id }}" {% if filters.ward == ward.id|stringformat:"s" %}selected{% endif %}>
                        Ward #{{ ward.ward_no }} - {{ ward.ward_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="form-label">Severity</label>
                <select name="severity" class="form-select">
                    <option value="">All Severities</option>
                    {% for severity in severities %}
                    <option value="{{ severity }}" {% if filters.severity == severity %}selected{% endif %}>
                        {{ severity }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="form-label">Date From</label>
                <input type="date" name="date_from" class="form-control" value="{{ filters.date_from|default:'' }}">
            </div>
            <div>
                <label class="form-label">Date To</label>
                <input type="date" name="date_to" class="form-control" value="{{ filters.date_to|default:'' }}">
            </div>
        </div>
        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-funnel"></i> Apply Filters
            </button>
            <a href="{% url 'admin_portal:department_tickets' department %}" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle"></i> Clear
            </a>
            <a href="{% url 'admin_portal:export_tickets' %}?department={{ department }}" class="btn btn-outline-success ms-auto">
                <i class="bi bi-download"></i> Export CSV
            </a>
        </div>
    </form>
</div>

<!-- Kanban Board -->
<div class="kanban-container">
    <!-- Submitted Column -->
    <div class="kanban-column">
        <div class="kanban-column-header submitted">
            <span><i class="bi bi-inbox"></i> Submitted</span>
            <span class="badge bg-warning">{{ submitted_tickets.count }}</span>
        </div>
        <div class="kanban-tickets" data-status="SUBMITTED">
            {% for ticket in submitted_tickets %}
            <div class="ticket-card" data-ticket-id="{{ ticket.id }}">
                <div class="ticket-header">
                    <span class="ticket-number">{{ ticket.ticket_number }}</span>
                    <input type="checkbox" class="ticket-checkbox" value="{{ ticket.id }}">
                </div>
                {% if ticket.civic_complaint.image %}
                <img src="{{ ticket.civic_complaint.image.url }}" alt="Complaint" class="ticket-image">
                {% endif %}
                <div class="ticket-category">{{ ticket.category }}</div>
                <div class="ticket-location">
                    <i class="bi bi-geo-alt"></i>
                    {{ ticket.civic_complaint.area }}
                </div>
                <div class="ticket-badges">
                    <span class="ticket-badge badge-severity">{{ ticket.severity }}</span>
                </div>
            </div>
            {% empty %}
            <p class="text-center text-muted mt-4">No submitted tickets</p>
            {% endfor %}
        </div>
    </div>
    
    <!-- Assigned Column -->
    <div class="kanban-column">
        <div class="kanban-column-header assigned">
            <span><i class="bi bi-person-check"></i> Assigned</span>
            <span class="badge bg-info">{{ assigned_tickets.count }}</span>
        </div>
        <div class="kanban-tickets" data-status="ASSIGNED">
            {% for ticket in assigned_tickets %}
            <div class="ticket-card" data-ticket-id="{{ ticket.id }}">
                <div class="ticket-header">
                    <span class="ticket-number">{{ ticket.ticket_number }}</span>
                    <input type="checkbox" class="ticket-checkbox" value="{{ ticket.id }}">
                </div>
                {% if ticket.civic_complaint.image %}
                <img src="{{ ticket.civic_complaint.image.url }}" alt="Complaint" class="ticket-image">
                {% endif %}
                <div class="ticket-category">{{ ticket.category }}</div>
                <div class="ticket-location">
                    <i class="bi bi-geo-alt"></i>
                    {{ ticket.civic_complaint.area }}
                </div>
                <div class="ticket-badges">
                    <span class="ticket-badge badge-severity">{{ ticket.severity }}</span>
                    {% if ticket.contractor %}
                    <span class="ticket-badge badge-contractor">
                        <i class="bi bi-person"></i> {{ ticket.contractor.contractor_name }}
                    </span>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <p class="text-center text-muted mt-4">No assigned tickets</p>
            {% endfor %}
        </div>
    </div>
    
    <!-- In Progress Column -->
    <div class="kanban-column">
        <div class="kanban-column-header in-progress">
            <span><i class="bi bi-gear"></i> In Progress</span>
            <span class="badge bg-primary">{{ in_progress_tickets.count }}</span>
        </div>
        <div class="kanban-tickets" data-status="IN_PROGRESS">
            {% for ticket in in_progress_tickets %}
            <div class="ticket-card" data-ticket-id="{{ ticket.id }}">
                <div class="ticket-header">
                    <span class="ticket-number">{{ ticket.ticket_number }}</span>
                    <input type="checkbox" class="ticket-checkbox" value="{{ ticket.id }}">
                </div>
                {% if ticket.civic_complaint.image %}
                <img src="{{ ticket.civic_complaint.image.url }}" alt="Complaint" class="ticket-image">
                {% endif %}
                <div class="ticket-category">{{ ticket.category }}</div>
                <div class="ticket-location">
                    <i class="bi bi-geo-alt"></i>
                    {{ ticket.civic_complaint.area }}
                </div>
                <div class="ticket-badges">
                    <span class="ticket-badge badge-severity">{{ ticket.severity }}</span>
                    {% if ticket.contractor %}
                    <span class="ticket-badge badge-contractor">
                        <i class="bi bi-person"></i> {{ ticket.contractor.contractor_name }}
                    </span>
                    {% endif %}
                    {% if ticket.ward %}
                    <span class="ticket-badge badge-ward">
                        <i class="bi bi-building"></i> Ward #{{ ticket.ward.ward_no }}
                    </span>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <p class="text-center text-muted mt-4">No tickets in progress</p>
            {% endfor %}
        </div>
    </div>
    
    <!-- Resolved Column -->
    <div class="kanban-column">
        <div class="kanban-column-header resolved">
            <span><i class="bi bi-check-circle"></i> Resolved</span>
            <span class="badge bg-success">{{ resolved_tickets.count }}</span>
        </div>
        <div class="kanban-tickets" data-status="RESOLVED">
            {% for ticket in resolved_tickets %}
            <div class="ticket-card" data-ticket-id="{{ ticket.id }}">
                <div class="ticket-header">
                    <span class="ticket-number">{{ ticket.ticket_number }}</span>
                    <input type="checkbox" class="ticket-checkbox" value="{{ ticket.id }}">
                </div>
                {% if ticket.civic_complaint.image %}
                <img src="{{ ticket.civic_complaint.image.url }}" alt="Complaint" class="ticket-image">
                {% endif %}
                <div class="ticket-category">{{ ticket.category }}</div>
                <div class="ticket-location">
                    <i class="bi bi-geo-alt"></i>
                    {{ ticket.civic_complaint.area }}
                </div>
                <div class="ticket-badges">
                    <span class="ticket-badge badge-severity">{{ ticket.severity }}</span>
                    {% if ticket.user_rating %}
                    <span class="ticket-badge" style="background-color: #FEF3C7; color: #92400E;">
                        <i class="bi bi-star-fill"></i> {{ ticket.user_rating }}/5
                    </span>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <p class="text-center text-muted mt-4">No resolved tickets</p>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Bulk Actions Toolbar -->
<div class="bulk-actions-toolbar" id="bulkActionsToolbar">
    <span id="selectedCount">0 selected</span>
    <button class="btn btn-sm btn-light" onclick="showBulkAssignModal()">
        <i class="bi bi-person-plus"></i> Assign
    </button>
    <button class="btn btn-sm btn-light" onclick="showBulkStatusModal()">
        <i class="bi bi-arrow-right"></i> Change Status
    </button>
    <button class="btn btn-sm btn-outline-light" onclick="clearSelection()">
        <i class="bi bi-x"></i> Clear
    </button>
</div>

<!-- Ticket Detail Modal -->
<div class="modal fade" id="ticketModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ticketModalTitle">Ticket Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="ticketModalBody">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Assign Modal -->
<div class="modal fade" id="bulkAssignModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Assign</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Contractor</label>
                    <select class="form-select" id="bulkContractor">
                        <option value="">Select Contractor</option>
                        {% for contractor in contractors %}
                        <option value="{{ contractor.id }}">{{ contractor.contractor_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Ward</label>
                    <select class="form-select" id="bulkWard">
                        <option value="">Select Ward</option>
                        {% for ward in wards %}
                        <option value="{{ ward.id }}">Ward #{{ ward.ward_no }} - {{ ward.ward_name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="performBulkAssign()">Assign</button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Status Modal -->
<div class="modal fade" id="bulkStatusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Change Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">New Status</label>
                    <select class="form-select" id="bulkStatus">
                        <option value="SUBMITTED">Submitted</option>
                        <option value="ASSIGNED">Assigned</option>
                        <option value="IN_PROGRESS">In Progress</option>
                        <option value="RESOLVED">Resolved</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="performBulkStatusUpdate()">Update</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let selectedTickets = new Set();
    
    // Initialize Sortable.js on all kanban columns
    document.querySelectorAll('.kanban-tickets').forEach(column => {
        new Sortable(column, {
            group: 'tickets',
            animation: 150,
            ghostClass: 'dragging',
            onEnd: function(evt) {
                const ticketId = evt.item.dataset.ticketId;
                const newStatus = evt.to.dataset.status;
                
                updateTicketStatus(ticketId, newStatus);
            }
        });
    });
    
    // Ticket click to show details
    document.querySelectorAll('.ticket-card').forEach(card => {
        card.addEventListener('click', function(e) {
            if (e.target.classList.contains('ticket-checkbox')) {
                return; // Don't open modal when clicking checkbox
            }
            
            const ticketId = this.dataset.ticketId;
            showTicketDetails(ticketId);
        });
    });
    
    // Checkbox selection
    document.querySelectorAll('.ticket-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function(e) {
            e.stopPropagation();
            const ticketId = this.value;
            
            if (this.checked) {
                selectedTickets.add(ticketId);
            } else {
                selectedTickets.delete(ticketId);
            }
            
            updateBulkToolbar();
        });
    });
    
    function updateBulkToolbar() {
        const toolbar = document.getElementById('bulkActionsToolbar');
        const count = document.getElementById('selectedCount');
        
        if (selectedTickets.size > 0) {
            toolbar.classList.add('active');
            count.textContent = `${selectedTickets.size} selected`;
        } else {
            toolbar.classList.remove('active');
        }
    }
    
    function clearSelection() {
        selectedTickets.clear();
        document.querySelectorAll('.ticket-checkbox').forEach(cb => cb.checked = false);
        updateBulkToolbar();
    }
    
    function updateTicketStatus(ticketId, newStatus) {
        showLoading();
        
        fetch(`/admin-portal/api/ticket/${ticketId}/status/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ new_status: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showToast('Ticket status updated successfully', 'success');
            } else {
                showToast('Failed to update ticket status', 'danger');
                location.reload(); // Reload to restore correct position
            }
        })
        .catch(error => {
            hideLoading();
            showToast('An error occurred', 'danger');
            location.reload();
        });
    }
    
    function showTicketDetails(ticketId) {
        const modal = new bootstrap.Modal(document.getElementById('ticketModal'));
        const modalBody = document.getElementById('ticketModalBody');
        
        modal.show();
        
        fetch(`/admin-portal/api/ticket/${ticketId}/`)
            .then(response => response.json())
            .then(data => {
                modalBody.innerHTML = `
                    <img src="${data.complaint.image_url}" alt="Complaint" class="modal-image">
                    
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Ticket Number</div>
                            <div class="info-value">${data.ticket_number}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Status</div>
                            <div class="info-value">
                                <span class="badge bg-primary">${data.status_display}</span>
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Category</div>
                            <div class="info-value">${data.category}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Severity</div>
                            <div class="info-value">${data.severity}</div>
                        </div>
                        ${data.suggested_tools ? `
                        <div class="info-item">
                            <div class="info-label"><i class="bi bi-tools me-1"></i>Suggested Tools</div>
                            <div class="info-value">
                                ${data.suggested_tools.split(',').map(tool => 
                                    `<span class="badge bg-primary me-1 mb-1">${tool.trim()}</span>`
                                ).join('')}
                            </div>
                        </div>
                        ` : ''}
                        ${data.safety_equipment ? `
                        <div class="info-item">
                            <div class="info-label"><i class="bi bi-shield-check me-1"></i>Safety Equipment</div>
                            <div class="info-value">
                                ${data.safety_equipment.split(',').map(equipment => 
                                    `<span class="badge bg-warning me-1 mb-1">${equipment.trim()}</span>`
                                ).join('')}
                            </div>
                        </div>
                        ` : ''}
                        <div class="info-item">
                            <div class="info-label">Location</div>
                            <div class="info-value">${data.complaint.area}, ${data.complaint.street}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Created</div>
                            <div class="info-value">${data.created_at}</div>
                        </div>
                    </div>
                    
                    <h6 class="mt-3 mb-2">Assignment</h6>
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Contractor</label>
                            <select class="form-select" id="assignContractor">
                                <option value="">Select Contractor</option>
                                {% for contractor in contractors %}
                                <option value="{{ contractor.id }}">{{ contractor.contractor_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Ward</label>
                            <select class="form-select" id="assignWard">
                                <option value="">Select Ward</option>
                                {% for ward in wards %}
                                <option value="{{ ward.id }}">Ward #{{ ward.ward_no }} - {{ ward.ward_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="assignTicket(${ticketId})">
                        <i class="bi bi-save"></i> Save Assignment
                    </button>
                    
                    <h6 class="mt-4 mb-2">Notes & Comments</h6>
                    <div class="notes-section">
                        ${data.notes.map(note => `
                            <div class="note-item">
                                <div class="note-header">
                                    <span class="note-author">${note.created_by}</span>
                                    <span class="note-time">${note.created_at}</span>
                                </div>
                                <div class="note-content">${note.content}</div>
                            </div>
                        `).join('') || '<p class="text-muted">No notes yet</p>'}
                    </div>
                    
                    <div class="input-group">
                        <input type="text" class="form-control" id="noteContent" placeholder="Add a note...">
                        <button class="btn btn-primary" onclick="addNote(${ticketId})">
                            <i class="bi bi-plus"></i> Add Note
                        </button>
                    </div>
                `;
                
                // Set current values
                if (data.contractor) {
                    document.getElementById('assignContractor').value = data.contractor.id;
                }
                if (data.ward) {
                    document.getElementById('assignWard').value = data.ward.id;
                }
            })
            .catch(error => {
                modalBody.innerHTML = '<div class="alert alert-danger">Failed to load ticket details</div>';
            });
    }
    
    function assignTicket(ticketId) {
        const contractorId = document.getElementById('assignContractor').value;
        const wardId = document.getElementById('assignWard').value;
        
        if (!contractorId && !wardId) {
            showToast('Please select at least one assignment', 'warning');
            return;
        }
        
        showLoading();
        
        fetch(`/admin-portal/api/ticket/${ticketId}/assign/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                contractor_id: contractorId || null,
                ward_id: wardId || null
            })
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showToast('Assignment saved successfully', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('Failed to save assignment', 'danger');
            }
        })
        .catch(error => {
            hideLoading();
            showToast('An error occurred', 'danger');
        });
    }
    
    function addNote(ticketId) {
        const content = document.getElementById('noteContent').value.trim();
        
        if (!content) {
            showToast('Please enter a note', 'warning');
            return;
        }
        
        showLoading();
        
        fetch(`/admin-portal/api/ticket/${ticketId}/note/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ content: content })
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showToast('Note added successfully', 'success');
                showTicketDetails(ticketId); // Refresh modal
            } else {
                showToast('Failed to add note', 'danger');
            }
        })
        .catch(error => {
            hideLoading();
            showToast('An error occurred', 'danger');
        });
    }
    
    function showBulkAssignModal() {
        const modal = new bootstrap.Modal(document.getElementById('bulkAssignModal'));
        modal.show();
    }
    
    function showBulkStatusModal() {
        const modal = new bootstrap.Modal(document.getElementById('bulkStatusModal'));
        modal.show();
    }
    
    function performBulkAssign() {
        const contractorId = document.getElementById('bulkContractor').value;
        const wardId = document.getElementById('bulkWard').value;
        
        if (!contractorId && !wardId) {
            showToast('Please select at least one assignment', 'warning');
            return;
        }
        
        showLoading();
        
        fetch('/admin-portal/api/bulk/assign/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                ticket_ids: Array.from(selectedTickets),
                contractor_id: contractorId || null,
                ward_id: wardId || null
            })
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showToast(data.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('Failed to assign tickets', 'danger');
            }
        })
        .catch(error => {
            hideLoading();
            showToast('An error occurred', 'danger');
        });
    }
    
    function performBulkStatusUpdate() {
        const newStatus = document.getElementById('bulkStatus').value;
        
        showLoading();
        
        fetch('/admin-portal/api/bulk/status/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                ticket_ids: Array.from(selectedTickets),
                new_status: newStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showToast(data.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('Failed to update status', 'danger');
            }
        })
        .catch(error => {
            hideLoading();
            showToast('An error occurred', 'danger');
        });
    }
</script>
{% endblock %}
